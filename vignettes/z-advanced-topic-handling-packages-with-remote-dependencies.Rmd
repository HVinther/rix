---
title: "z - Advanced topic: Handling packages with remote dependencies"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{z-advanced-topic-handling-packages-with-remote-dependencies}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=FALSE}
library(rix)
```

## Introduction

Packages published on CRAN must have their dependencies on either CRAN or
BioConductor, but not on GitHub. However, there are many packages available on
GitHub that never get published on CRAN, and some of these packages may even
depend on other packages that are also only available on GitHub. `{rix}` makes
it possible to install packages from GitHub and if these packages have
dependencies that are also on Github, these also get correctly added to the
generated `default.nix`.

There are however certain caveats you should be aware of.

## The {lookup} package

As an example we are going to use the
[{lookup}](https://github.com/jimhester/lookup) package which has only been
released on GitHub. [Here is the
repository](https://github.com/jimhester/lookup). This package comes with the
`lookup()` function which makes it possible to check the source code of any
function from a loaded package, even if the source of that function is in C or
Fortran. To create a reproducible development environment that makes
[{lookup}](https://github.com/jimhester/lookup) available to you, you could use
the following `rix::rix()` call:

```{r, eval = F}
path_default_nix <- tempdir()

rix(
  r_ver = "latest-upstream",
  r_pkgs = NULL,
  system_pkgs = NULL,
  git_pkgs = list(
    package_name = "lookup",
    repo_url = "https://github.com/jimhester/lookup/",
    commit = "eba63db477dd2f20153b75e2949eb333a36cccfc"
  ),
  ide = "other",
  project_path = path_default_nix,
  overwrite = TRUE,
  print = TRUE
)
```

This will generate the following `default.nix`:



as you can see, several other packages hosted on Github were added
automatically. This is because these were listed as remote dependencies in
`{lookup}`'s `DESCRIPTION` file:

```
Remotes:
    jimhester/highlite,
    gaborcsardi/gh,
    hadley/memoise
```

## Caveats

`{highlite}` is a dependency of [{lookup}](https://github.com/jimhester/lookup)
that is only available on GitHub. `{gh}` and `{memoise}` are also listed as
remote dependencies, however, they are also available on CRAN. What likely happened
here was that `{gh}` and `{memoise}` were not yet available on CRAN at the time
when `{lookup}` was written (which was more than 6 years ago now). Because they
are listed as remote dependencies, they will also be built from Github instead of 
CRAN. Here, it is up to you to decide if you want to keep the Github version of 
these packages, or if you should instead include the released CRAN version. Depending
on what you want to do, going for the CRAN release of the packages might be advisable.
For example here, trying to build this expression will not work:

This is because `{httr2}` is a package that needs to be compiled from source and will
not benefit from the Nix-specific fixes that it needs to compile successfully. Change 
your `default.nix` from:

to:

and then trying to build it will work. In the second, manually edited
expression, `{httr2}` will now build successfully because Nix is instructed to
build the CRAN version by applying [this
fix](https://github.com/NixOS/nixpkgs/blob/7b87fced8bc525d466c7258a042bd12ea336a3c6/pkgs/development/r-modules/default.nix#L1817)
which was added there by packagers and maintainers of the R programming language
for `nixpkgs` (it is exactly the same if you tried to install `{httr2}` from Github
on Windows: you would need to build it from source and thus make
sure that you have the required system-level dependencies to build it. Instead, it is
easier to install a pre-compiled binary from CRAN).

Another important point to address is that if remote dependincies are listed in 
a `DESCRIPTION` file like this:

```
Remotes:
    jimhester/highlite,
    gaborcsardi/gh,
    hadley/memoise
```

`{rix}` will automatically use the latest commit from these repositories as the revision.
If instead the remotes are listed like this:

```
Remotes:
    jimhester/highlite@abc123,
    gaborcsardi/gh@def123,
    hadley/memoise@ghi123
```

then the listed commits will be used. Only commits can be used, anything else
listed there (such as pull request numbers or release tags) will not work with
`{rix}`.


